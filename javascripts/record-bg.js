import{asRecorder}from"./";import{sendMessageToTab}from"../../util/message";let currentRecordingTabId="",recordType="",recordOptions=null,contentInsertStatus={};const tabids={};let recordingInfo={};const currentversion=chrome.runtime.getManifest().version,currentRecordingTabUrl="",port=chrome.runtime.connect({name:"record"});function saveStorage(e,o,r){chrome.storage.local.set({[e]:o},r)}function getCurrentTab(e,o){chrome.tabs.query(Object.assign({active:!0},e),(function(e){o(e[0])}))}function refreshUserInfo(){chrome.cookies.getAll({url:baseUrl},(function(e){if(e){for(var o="",r=0,t=e.length;r<t;r++)"screenshot_personal_uid"===e[r].name&&(o=e[r].value);o?$.ajax({method:"GET",url:baseUrl+"/api/v1/user/einfo"}).done((function(e){var r=parseInt(e.data.premiumLevel);premiumLevel_=r;var t=e.data.newPremium,n=e.data.permission.allowUploadImage,i=e.data.permission.allowVideoCreate,a=e.data.counts.imageLimitation,c=e.data.counts.imageTotalLimitation,s=e.data.counts.videoLimitation,d=e.data.counts.videoTotalLimitation;chrome.storage.local.set({userinfo:{uid:o,newPremium:t,premiumLevel:r,allowUploadImage:n,allowVideoCreate:i,imageLimitation:a,imageTotalLimitation:c,videoLimitation:s,videoTotalLimitation:d}})})):(premiumLevel_=0,chrome.storage.local.remove("userinfo"))}}))}function openNewTab(e){getCurrentTab({},(function(o){var r={url:e};o&&o.incognito||!o?chrome.windows.getAll((function(e){e.forEach((function(e){e.incognito||"normal"!==e.type||(r.windowId=e.id)})),createTabWithInfo(r)})):(r.index=(o?o.index:currentTabIndex||0)+1,r.windowId=o?o.windowId:currentWindowId,createTabWithInfo(r))}))}function createTabWithInfo(e){e&&e.url&&(e.hasOwnProperty("index")&&!e.index&&delete e.index,chrome.tabs.create(e,(function(e){tabids[e.id]=tabid,tabid=e.id,chrome.windows.update(e.windowId,{focused:!0})})))}function sendMessage(e,o){chrome.runtime.sendMessage(e,o)}function getUserSigninStatus(e){chrome.cookies.get({url:baseUrl,name:"screenshot_personal_uid"},(function(o){o?e&&e(!0):e&&e(!1)}))}chrome.runtime.onMessage.addListener(((e,o,r)=>{if("startRecord"===e.action){recordOptions=e.recordOptions,recordType=recordOptions.recordType;const o=recordOptions.recordingTabId;if(currentRecordingTabId=o,"camera"===recordType)return;currentRecordingTabId=o,insertContentScript(o).then((function(){sendMessageToTab(o,{action:"insertRecordDiv"}),"custom"===recordType&&sendMessageToTab(o,{action:"prepareCustom"})})).catch((function(e){})),"custom"===recordType?customRecordOption=request.options:("camera"!==recordType&&recordOptions.isRecordCam&&initCamera(recordOptions.camDeviceId),recordOptions.isShowToolbar,beginRecord(recordOptions))}else"stopStream"===e.action&&stopStream()}));