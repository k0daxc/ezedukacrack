var camDevices=[],baseURL="https://www.awesomescreenshot.com",isSignIn=!1,meter=null,rafID=null,volumeStream=null,premiumLevel=0,newPremium=!1,isAllowVa=null,allowUploadImage=!1,allowVideoCreate=!1,imageLimitation=100,imageTotalLimitation=0,videoLimitation=20,videoTotalLimitation=0,prepareInterval=null,isFileUrl=!1,isAllowContentJs=!0,fileAllowedAccess=!1,mediaDevices=null,haveAudioDevices=!1,haveVideoDevices=!1,isAllowedMic=!1,isAllowedCam=!1,availableAudioDevices=[],availableVideoDevices=[],init=!1,isGetUserInfo=!1,haveSetDefaultTab=!1,isAutoRecordTab=!1;let recordTabId="",recordType="",openType="",lastTabId="",recordWinId="",options={},recordingStatus="",Bg={};var url,enableSelected=!0;function openNewTab(e){chrome.tabs.create({url:e})}function sendMessageToTab(e,i,o){chrome.tabs.sendMessage(e,i,o)}function getCurrentTab(e,i){chrome.tabs.query(Object.assign({active:!0,currentWindow:!0},e),(function(e){i(e[0])}))}function updateOptions(e,i){"object"==typeof e?options={...options,...e}:"string"==typeof e&&(options={...options,[e]:i}),saveStorage("options",options)}function saveStorage(e,i,o){chrome.storage.local.set({[e]:i},o)}async function getStorage(e){return await new Promise((i=>{e?chrome.storage.local.get([e],(o=>{i(o[e])})):chrome.storage.local.get(null,(e=>{i(e)}))}))}i18n();let recordingTimer=null;async function initPopup(){const e=await getStorage();options=e.options;const i=e.recordingInfo;i&&i.recordWinId&&(Bg=chrome.extension.getViews({windowId:i.recordWinId})[0]),recordSettings=e.recordSettings,recordingStatus=e.recordingStatus,options["dark-mode"]&&$("body").addClass("dark-mode"),"recording"!==recordingStatus&&"preparing"!==recordingStatus&&chrome.cookies.getAll({url:baseURL},(function(e){if(chrome.runtime.lastError,e){for(var i=0,o=e.length;i<o;i++)if("screenshot_personal_fullname"===e[i].name)var t=decodeURI(e[i].value);else if("screenshot_personal_type"===e[i].name)var a=e[i].value;else if("screenshot_personal_premium_level"===e[i].name)var n=e[i].value;else if("screenshot_personal_permission"===e[i].name)e[i].value.split(",");else if("screenshot_personal_uid"===e[i].name)var c=e[i].value;t?(isSignIn=!0,$(".aws-info").find(".user-name").text(t).attr("title",t),$("#no-signin").hide(),$("#aws-account").show(),chrome.storage.local.get("userinfo",(function(e){e.userinfo&&(premiumLevel=parseInt(n),newPremium=e.userinfo.newPremium,allowUploadImage=e.userinfo.allowUploadImage,allowVideoCreate=e.userinfo.allowVideoCreate,imageLimitation=e.userinfo.imageLimitation,imageTotalLimitation=e.userinfo.imageTotalLimitation,videoLimitation=e.userinfo.videoLimitation,videoTotalLimitation=e.userinfo.videoTotalLimitation,options.videoTotalLimitation=videoTotalLimitation,isGetUserInfo=!0,chrome.storage.local.set({userinfo:{newPremium:e.userinfo.newPremium,uid:e.userinfo.uid,premiumLevel:parseInt(n),allowUploadImage:e.userinfo.allowUploadImage,allowVideoCreate:e.userinfo.allowVideoCreate,imageLimitation:e.userinfo.imageLimitation,imageTotalLimitation:e.userinfo.imageTotalLimitation,videoLimitation:e.userinfo.videoLimitation,videoTotalLimitation:e.userinfo.videoTotalLimitation}}),updateSavePlace()),$("#loading").addClass("active"),$.ajax({method:"GET",url:baseURL+"/api/v1/user/einfo"}).done((function(e){premiumLevel=parseInt(e.data.premiumLevel),newPremium=e.data.newPremium,allowUploadImage=e.data.permission.allowUploadImage,allowVideoCreate=e.data.permission.allowVideoCreate,imageLimitation=e.data.counts.imageLimitation,imageTotalLimitation=e.data.counts.imageTotalLimitation,videoLimitation=e.data.counts.videoLimitation,videoTotalLimitation=e.data.counts.videoTotalLimitation,options.videoTotalLimitation=videoTotalLimitation,isGetUserInfo=!0,chrome.storage.local.set({userinfo:{newPremium,uid:c,premiumLevel,allowUploadImage,allowVideoCreate,imageLimitation,imageTotalLimitation,videoLimitation,videoTotalLimitation}}),$("#loading").removeClass("active"),updateSavePlace(),setTimeout((function(){$(document.body).removeClass("no-transition")}),500)})).catch((function(e){$("#loading").addClass("hide"),setTimeout((function(){$(document.body).removeClass("no-transition")}),500)}))}))):(isGetUserInfo=!0,chrome.storage.local.remove("userinfo"),"local"===options["save-location"]&&showLimit(),$("#loading").addClass("hide"),$("#no-signin").show(),$("#aws-account").hide(),updateSavePlace()),"0"==a?$(".aws-user").removeClass("premium"):void 0===a?($(".aws-premium-icon").hide(),$(".aws-upgrade").hide()):$(".aws-user").addClass("premium"),isSignIn||setSaveLocal()}})),"recording"===recordingStatus&&(switchView("recording-view"),updateRecordUI(),Bg.isRecordingPaused&&(updatePausedUI(!0),Bg.socketClient&&Bg.socketClient.paused&&$("#recording-error").show()),recordingTimer=setInterval(updateTime,100)),"preparing"===recordingStatus&&(Bg.isInCountdown?switchView("video-countdown-view"):switchView("video-prepare-view"),prepareInterval=setInterval((function(){"recording"===recordingStatus?(switchView("recording-view"),clearInterval(prepareInterval),prepareInterval=null,recordingTimer=setInterval(updateTime,100)):Bg.isInCountdown&&$("#countdown-num").text(Bg.asRecorder._cd)}),100)),initMain(),initCaptureTab(),initRecordTab()}function initMain(){$("#aws-info-upgrade").on("click",(function(){Bg.googleEvent("upgrade from main menu","upgrade"),openNewTab("https://www.awesomescreenshot.com/pricing?from=extMenu"),window.close()})),$("#aws-login").on("click",(function(){openNewTab("https://www.awesomescreenshot.com/signin?from=ext_pop_bottom"),window.close()})),$(".link-item").on("click",(function(){openNewTab($(this).attr("data-url")),window.close()})),$("#user").on("click",(function(){openNewTab("https://www.awesomescreenshot.com/settings"),window.close()})),$(".feedback").on("click",(function(){openNewTab("/feedback.html"),window.close()})),$(".backToMenu").on("click",(function(){switchView("main-menu")})),$(".tab-header-item").on("click",(function(){var e=$(this).attr("data-tab");($(".tab-header").removeClass("screenshot record").addClass(e),$(".tab-header-item").removeClass("active"),$(this).addClass("active"),$(".tab-item").removeClass("active"),$(".tab-item.tab-"+e).addClass("active"),e&&(options.activeTab=e),"record"===e)?"none"===$("#audio").css("display")||getVolume():"screenshot"===e&&closeVolume()})),"record"===options.popupTab||"remember"===options.popupTab&&"record"===options.activeTab?$(".tab-header-item[data-tab='record']").trigger("click"):"screenshot"!==options.activeTab&&updateOptions({activeTab:"screenshot"}),$(".action-btn").on("click",(function(){var e=$(this);e.hasClass("option")?openNewTab("/option-react.html"):e.hasClass("feedback")?openNewTab("/feedback.html"):e.hasClass("more")?(e.toggleClass("expand"),$(".more-links").toggle()):e.hasClass("recording")?openNewTab("/video-list.html"):e.hasClass("sign-out")&&openNewTab("https://www.awesomescreenshot.com/web/user/logout")})),$(".more-links-item").on("click",(function(){var e=$(this);if(e.hasClass("mp"))var i=baseURL+"/all_images";else if(e.hasClass("mv"))i=baseURL+"/all_videos";else if(e.hasClass("logout"))i=baseURL+"/web/user/logout";openNewTab(i)})),chrome.tabs.query({active:!0,currentWindow:!0},(function(e){var i=e[0],o=(url=i.url).match(/(https?|file):\/\/*\/*/gi);if(/Edg/.test(window.navigator.userAgent)?(null==o||url.match(/https:\/\/microsoftedge.microsoft.com\/addons/i))&&(isAllowContentJs=!1):(null==o||url.match(/https:\/\/chrome.google.com/i))&&(isAllowContentJs=!1),"complete"!=i.status&&($("#selected").attr({title:"Page still loading! Please wait."}).addClass("disabled"),enableSelected=!1),/http|https|file|ftp/.test(url.slice(0,5))||(isAllowContentJs=!1),isFileUrl=!!/file:/.test(url.slice(0,5)),isAllowContentJs)$("#record-type-custom");else{var t=document.getElementsByClassName("content-affect");Array.prototype.forEach.call(t,(function(e){e.classList.add("disable")})),$("#record-type-custom").attr({disabled:!0})}})),$("#open-setting").on("click",(function(){var e="chrome://extensions/?id="+chrome.runtime.id;chrome.tabs.create({url:e})})),chrome.extension.isAllowedFileSchemeAccess((function(e){fileAllowedAccess=e})),chrome.runtime.onMessage.addListener((function(e,i,o){switch(e.action){case"enable_selected":if(url.match(/https:\/\/*\/*/gi))return void $("#selected").attr({title:"For security reason, Capture Selected Area doesn't work in https pages!"});enableSelected=!0,$("#selected").attr({title:""}).css({color:"#000"});break;case"shownew":case"closeWin":window.close();break;case"entireCaptureProgress":$("#entire-progress-percentage").text(e.percentage),$("#entire-progress").css("width",e.percentage),e.scrollNum&&e.scrollNum>=9&&$("#stop-msg").show();break;case"updateRecordUI":updateRecordUI();break;case"page-video-status":e.status?selectTabRecord():hiddeAutoTabRecordTip()}})),$(".custom-select").find(".select-option-item").on("mousedown",(function(e,i){var o=$(this),t=$(this).attr("data-value"),a=$(this).attr("data-text"),n=$(this).parents(".custom-select").attr("data-option");function c(e){o.parents(".custom-select").attr("data-value",t).find(".display-item").text(a),o.siblings().removeClass("selected").end().addClass("selected"),e||updateOptions({[n]:t})}if("max_resolution"===n){var r="local"===options["save-location"];"720"===t?(c(r),updateResolutionUI(t)):"1080"!==t&&"4k"!==t||(isSignIn?r?premiumLevel>1?(c(),updateResolutionUI(t)):openPopup("signin-local-upgrade","Record_resolution"):premiumLevel>1||videoTotalLimitation<videoLimitation?(c(),updateResolutionUI(t)):openPopup("signin-limit-upgrade","Record_resolution"):openPopup("no-signin-local-upgrade","Record_resolution"))}else"save-location"===n?(isSignIn?"local"===t?parseInt(premiumLevel)<2&&0!==newPremium||0===parseInt(premiumLevel)?showLimit():(parseInt(premiumLevel),hideTip()):parseInt(premiumLevel)<2&&videoTotalLimitation<videoLimitation&&videoTotalLimitation>=.75*videoLimitation?showTry():hideTip():"local"===t?showLimit():hiddeLimit(),"local"===t?$("#record-bubble").removeClass("hidde-bubble"):($("#record-bubble").addClass("hidde-bubble"),i||isSignIn||openPopup("sign-in","record")),c(),updateVideoSaveUI(t),isGetUserInfo&&restoreSettings()):"record_countdown"===n?c():"save-capture-location"===n&&("local"===t?$("#capture-bubble").removeClass("hidde-bubble"):($("#capture-bubble").addClass("hidde-bubble"),i||isSignIn||openPopup("sign-in","capture")),c(),updateImageSaveUI(t),isSignIn&&"local"!==t&&parseInt(premiumLevel)<1&&imageTotalLimitation>=.75*imageLimitation&&imageTotalLimitation<imageLimitation?showTryImage():hideTryImage())})),chrome.windows.getCurrent((function(e){getCurrentTab({windowId:e.id},(function(i){chrome.action.getBadgeText({tabId:i.id},(function(i){"New"==i&&(chrome.action.setBadgeText({text:""}),chrome.tabs.create({url:"https://blog.awesomescreenshot.com/2022/02/15/workspace-a-collaborative-visual-repository-for-your-team/"}),options.newClickVersion=Bg.newClickVersion,e.close())}))}))}))}function initRecordTab(){initRecordMenu()}function initCaptureTab(){$(".capture-menu").find(".action-item").on("click",(function(){var e=this.id;if("visible"===e||"selected"===e||"entire"===e||"delay"===e)if(isFileUrl&&!fileAllowedAccess)openPopup("file-access");else if(isAllowContentJs||isFileUrl||"visible"===e||"delay"===e){if(getCurrentTab({},(function(e){sendMessageToTab(e.id,{action:"tabCanScroll"})})),"cloud"===options["save-capture-location"]){if(!isSignIn)return void openPopup("sign-in","capture");if(parseInt(premiumLevel)<1&&imageTotalLimitation>=imageLimitation)return void openPopup("upgrade-alert-img")}sendMessage({action:e,actionFrom:"pop"}),Bg.googleEvent("capture "+e,"capture"),"entire"===e?switchView("capturing-view"):window.close()}else openPopup("reject-access");else if("desktop"===e){if("cloud"===options["save-capture-location"]){if(!isSignIn)return void openPopup("sign-in","capture");if(parseInt(premiumLevel)<1&&imageTotalLimitation>=imageLimitation)return void openPopup("upgrade-alert-img")}Bg.beginDesktop(),Bg.googleEvent("capture desktop","capture"),window.close()}else if("annotate"===e){var i=chrome.runtime.getURL("")+"upload.html";chrome.tabs.create({url:i}),Bg.googleEvent("capture local","capture"),window.close()}})),options.delay_sec&&$("#delay").find(".countdown").text(options.delay_sec+"s"),""!==options.desktop_delay_sec&parseInt(options.desktop_delay_sec)>0&&$("#desktop").find(".countdown").text(options.desktop_delay_sec+"s"),addShortcut(),$("#stop-entire-capture").on("click",(function(){sendMessage({action:"stop-entire-capture"})}))}function addShortcut(){if(options.msObj){var e=options.msObj,i=1==e.visible.enable?"Ctrl+Shift+"+e.visible.key:"",o=1==e.selected.enable?"Ctrl+Shift+"+e.selected.key:"",t=1==e.entire.enable?"Ctrl+Shift+"+e.entire.key:"";i&&$("#visible").addClass("tooltip delay").attr("aria-label",i),i&&$("#selected").addClass("tooltip delay").attr("aria-label",o),t&&$("#entire").addClass("tooltip delay").attr("aria-label",t)}}function selectTabRecord(){haveSetDefaultTab=!0,autoSelectTabRecord()}function autoSelectTabRecord(){$("#record-type-tab").trigger("click").trigger("change",!0),$("#record-mic").prop("checked",!1),$("#tabsound").show(),$("#tabsoundoff").hide(),$("#record-tabsound").prop("checked",!0),$(".record-tip.auto-tab-record").css("display","flex"),updateAudioDeviceUI(!1)}function hiddeAutoTabRecordTip(){$(".record-tip.auto-tab-record").css("display","none")}function updateAudioDeviceUI(e){isAllowedMic&&e&&availableAudioDevices.length>0?($("volume-canvas").show(),"record"===$(".tab-header-item.active").attr("data-tab")&&getVolume(),$("#mute").hide(),$("#audio").show(),$("#mic-device").attr("aria-label",chrome.i18n.getMessage("off_mic_btn"))):!isAllowedMic||availableAudioDevices.length<1?($("#mute").show(),$("#mute").addClass("red"),$("#audio").hide(),$("#mic-device").attr("aria-label",chrome.i18n.getMessage("on_mic_btn")),closeVolume()):e||($("#mute").show(),$("#mute").removeClass("red"),$("#audio").hide(),$("#mic-device").attr("aria-label",chrome.i18n.getMessage("on_mic_btn")),closeVolume())}function updateCamDeviceUI(e){isAllowedCam&&e&&availableVideoDevices.length>0?($("#nocam").hide(),$("#cam").show(),$("#cam-device").attr("aria-label",chrome.i18n.getMessage("off_cam_btn"))):!isAllowedCam||availableVideoDevices.length<1?($("#nocam").show(),$("#nocam").addClass("red"),$("#cam").hide(),$("#cam-device").attr("aria-label",chrome.i18n.getMessage("on_cam_btn"))):e||($("#nocam").show(),$("#nocam").removeClass("red"),$("#cam").hide(),$("#cam-device").attr("aria-label",chrome.i18n.getMessage("on_cam_btn")))}function openPopup(e,i){var o=$(".popup[data-name="+e+"]");o.show(),i&&o.find(".popup-btn").attr("data-reason",i),"sign-in"===e&&($(".tab-header").hasClass("record")?($("#sign-in-reason").text("videos"),$(".popup").find(".change-local").hide()):($("#sign-in-reason").text("screenshots"),$(".popup").find(".change-local").show()))}function closePopup(e){$(".popup[data-name="+e+"]").hide()}function i18n(){$("[data-i18n-id]").each((function(){var e=$(this).attr("data-i18n-id");$(this).html(chrome.i18n.getMessage(e))})),$("[data-i18n-text-id]").each((function(){var e=$(this).attr("data-i18n-text-id");$(this).attr("data-text",chrome.i18n.getMessage(e))})),$("[data-i18n-aria-label]").each((function(){var e=$(this).attr("data-i18n-aria-label");$(this).attr("aria-label",chrome.i18n.getMessage(e))}))}function switchView(e){"main-menu"!==e&&closeVolume(),$(".layout-view").hide(),$("#"+e).show()}function capturing(){$("ul").remove(),$(".aws-account, .sep").hide(),$("#capturing").fadeIn("slow")}function sendMessage(e){chrome.runtime.sendMessage(e)}function getAllDevices(){return new Promise((function(e,i){getAllAudioVideoDevices((function(i){haveAudioDevices=(mediaDevices=i).audioInputDevices.length>0,haveVideoDevices=mediaDevices.videoInputDevices.length>0,availableAudioDevices=getDevices(mediaDevices.audioInputDevices),availableVideoDevices=getDevices(mediaDevices.videoInputDevices),e()}))}))}function getMicPermisstion(){return navigator.permissions.query({name:"microphone"}).then((function(e){return"granted"===e.state&&(isAllowedMic=!0),e.state}))}function getCamPermisstion(){return navigator.permissions.query({name:"camera"}).then((function(e){return"granted"===e.state&&(isAllowedCam=!0),e.state}))}function getDevices(e){return e.filter((function(e,i,o){return""!==e.label&&o.findIndex((function(i){return i.deviceId===e.deviceId}))===i}))}function updateResolutionUI(e){switch(e){case"720":$("#hd_icon").show(),$("#fhd_icon").hide(),$("#4k_icon").hide();break;case"1080":$("#hd_icon").hide(),$("#fhd_icon").show(),$("#4k_icon").hide();break;case"4k":$("#hd_icon").hide(),$("#fhd_icon").hide(),$("#4k_icon").show()}}function updateVideoSaveUI(e){"local"===e?($("#cloud_icon").hide(),$("#local_icon").show()):($("#cloud_icon").show(),$("#local_icon").hide())}function updateImageSaveUI(e){"local"===e?($("#cloud_icon_capture").hide(),$("#local_icon_capture").show()):($("#cloud_icon_capture").show(),$("#local_icon_capture").hide())}function showTry(){hiddeLimit(),$(".record-tip.try.video").css("display","flex"),$(".record-tip.video").find(".count").text(videoTotalLimitation+"/"+videoLimitation)}function showTryImage(){$(".record-tip.try.img").css("display","flex"),$(".record-tip.img").find(".count_image").text(imageTotalLimitation+"/"+imageLimitation)}function hideTryImage(){$(".record-tip.try.img").hide()}function showLimit(){$(".start-container").hasClass("limit")||$(".start-container").addClass("limit"),$(".record-tip.limit").show(),$(".record-tip.try").hide()}function hiddeLimit(){$(".start-container").removeClass("limit"),$(".record-tip.limit").hide()}function hideTip(){$(".record-tip.try.video").hide(),hiddeLimit()}function updateSavePlace(){$(".custom-select[data-option=save-location]").find(".select-option-item[data-value="+options["save-location"]+"]").trigger("mousedown",["autofill"]),$(".custom-select[data-option=save-capture-location]").find(".select-option-item[data-value="+options["save-capture-location"]+"]").trigger("mousedown",["autofill"])}function updateRecordTypeUI(e){$(".record-type-item").removeClass("selected"),$("#record-type-"+e).parents(".record-type-item").addClass("selected"),"tab"!==e&&"custom"!==e?($("#tab-sound").hide(),$(".option-source.ann").removeClass("fullWidth"),$(".option-source.ann").addClass("halfWidth"),$("#controlBar").html(chrome.i18n.getMessage("ctl_bar_title"))):($("#tab-sound").show(),$(".option-source.ann").addClass("fullWidth"),$(".option-source.ann").removeClass("halfWidth"),$("#controlBar").html("Control bar & Annotation tools")),"camera"===e?($(".record-option-camera").hide(),$(".record-option-camera-only").show(),$(".option-source.ann").hide(),updateCamDeviceUI(!0)):($(".record-option-camera").show(),$(".record-option-camera-only").hide(),$(".option-source.ann").show()),availableVideoDevices.length||("camera"===e?$("#record-start").addClass("disabled"):$("#record-start").removeClass("disabled"))}function updateTimerValue(e,i,o){switch(e){case"hour":isNaN(i)?i=0:i>23?i=23:i<0&&(i=0),$("#hour-field")[0].value=i,$("#hour-label").html(i),o&&$("#hour-field").blur();break;case"min":isNaN(i)?i=0:i>59?i=59:i<0&&(i=0),$("#min-field")[0].value=i,$("#min-label").html(i),o&&$("#min-field").blur();break;case"sec":isNaN(i)?i=0:i>59?i=59:i<0&&(i=0),$("#sec-field")[0].value=i,$("#sec-label").html(i),o&&$("#sec-field").blur()}}function updateTimerVisiable(){$("#auto-stop").prop("checked")?$(".menu-cell.autoStop").removeClass("hidden"):$(".menu-cell.autoStop").addClass("hidden")}function updateTimerTips(){var e=parseInt($("#sec-field")[0].value),i=parseInt($("#min-field")[0].value),o=parseInt($("#hour-field")[0].value);if(!$("#auto-stop").prop("checked")||0==e&&0==i&&0==o)$(".auto-stop-tip").hide();else{var t="";o>0?(t+=o+"h",t+=i+"m",t+=e+"s"):i>0?(t+=i+"m",t+=e+"s"):t+=e+"s",$(".tip-time").html(t),$(".auto-stop-tip").css("display","flex")}}function updateRecordingUI(){!Bg.isAutoTimerStop||0===Bg.timerHour&&0===Bg.timerMin&&0===Bg.timerSec?($(".switch-action").find(".status").text("Off"),$(".progress-field").hide(),$(".menu-cell.recording").hide()):updateTimerProgressField()}function updateTimerProgressField(){if("recording"===recordingStatus&&Bg.isAutoTimerStop){var e="";Bg.timerHour>0?(e+=Bg.timerHour+"h",e+=Bg.timerMin+"m",e+=Bg.timerSec+"s"):Bg.timerMin>0?(e+=Bg.timerMin+"m",e+=Bg.timerSec+"s"):e+=Bg.timerSec+"s",$(".switch-action").find(".status").text("On"),$(".progress-field").show(),$(".progress-field").find(".auto-time").text(e),updateTimerProgress()}}function updateAutoTimerUI(){"recording"===recordingStatus&&($("#reminder").hide(),$("#countdown").hide(),$(".menu-head").find(".title").text("Back"),$(".input-field.reset").hide(),$(".menu-cell.tip.autoStop").hide(),$(".menu-head").addClass("recording"),updateAutoTimerFromBg(),updateTimerVisiable())}function updateAutoTimerFromBg(){"recording"===recordingStatus&&($("#auto-stop").prop("checked",Bg.isAutoTimerStop),$("#sec-field")[0].value=Bg.timerSec,$("#sec-label").html(Bg.timerSec),$("#min-field")[0].value=Bg.timerMin,$("#min-label").html(Bg.timerMin),$("#hour-field")[0].value=Bg.timerHour,$("#hour-label").html(Bg.timerHour),Bg.timerHour+Bg.timerMin+Bg.timerSec>0&&Bg.isAutoTimerStop?$(".menu-cell.recording").show():$(".menu-cell.recording").hide(),updateTimerProgressField())}function updateTimerProgress(){if(Bg.isAutoTimerStop){var e=1e3*(Bg.timerSec+60*Bg.timerMin+60*Bg.timerHour*60),i=Bg.recordTimeLength-Bg.startAutoStop;if(i>0&&e>0){var o=i/e;(o=o.toFixed(2))>1?o=1:o<.01&&(o=.01),$(".progress-field").find(".progrees-value").css("width",100*o+"%")}}}function initRecordMenu(){function e(e,i){for(var o=0;o<i.length;o++)if(e===i[o].deviceId)return!0;return!1}function i(i,o){if(o.length){var t=$("#"+i+"-source");o.forEach((function(e){$("<option value='"+e.deviceId+"'>"+e.label+"</option>").appendTo(t)})),options[i+"-deviceId"]&&e(options[i+"-deviceId"],o)&&t.val(options[i+"-deviceId"])}}function o(i,o){if(o.length){var t=$("#"+i+"-source-recording");o.forEach((function(e){$("<option value='"+e.deviceId+"'>"+e.label+"</option>").appendTo(t)})),options[i+"-deviceId"]&&e(options[i+"-deviceId"],o)&&t.val(options[i+"-deviceId"])}}function t(){options.record_tabsound?($("#tabsound").show(),$("#tabsoundoff").hide(),$("#record-tabsound").prop("checked",!0)):($("#tabsound").hide(),$("#tabsoundoff").show(),$("#record-tabsound").prop("checked",!1))}function a(e){var i="none"!==$("#audio").css("display"),o=$("#ctl-bar").prop("checked"),t=$("input[name=record-type]:checked").val(),a=options.record_countdown,n=$(".custom-select[data-option=max_resolution]").attr("data-value")||720,c=$(".custom-select[data-option=save-location").attr("data-value"),r="none"!==$("#cam").css("display"),s=$("#cam-source").val();$("#cam-source").val()&&options["cam-deviceId"]||availableVideoDevices.length>0&&updateOptions({"cam-deviceId":s=availableVideoDevices[0].deviceId});var d=$("#mic-source").val();$("#mic-source").val()&&options["mic-deviceId"]||availableAudioDevices.length>0&&updateOptions({"mic-deviceId":d=availableAudioDevices[0].deviceId});var l=$("#record-tabsound").prop("checked");if(!i&&availableAudioDevices.length>0&&!e&&options["allow-remind-mic"])openPopup("open-mic");else{var u=parseInt($("#sec-field")[0].value),p=parseInt($("#min-field")[0].value),m=parseInt($("#hour-field")[0].value),h={isRecordMic:i,recordType:t,countdown:a,saveLocation:c,resolution:n,isRecordCam:r,isShowToolbar:o,camDeviceId:s,micDeviceId:d,isRecordTabSound:l,isAutoStop:$("#auto-stop").prop("checked"),autoStopHour:m,autoStopMin:p,autoStopSec:u},g=window.screen.width,v=window.screen.height,f={"4k":{width:3084,height:2160},1080:{width:1920,height:1080},720:{width:1280,height:720}};if("desktop"===t&&(g<f[n].width?(h.width=g,h.height=v):(h.width=f[n].width,h.height=f[n].height)),"cloud"===options["save-location"]){if(isSignIn){if(haveAudioDevices&&0===availableAudioDevices.length)w="/setup-react.html?from=record&isSignIn=true"}else if(haveAudioDevices){if(0!==availableAudioDevices.length)return void openPopup("sign-in","record");var w="/setup-react.html?from=record"}else var w="/setup-react.html?from=record&isGranted=true";if(w&&(!options.has_setup||!isSignIn))return chrome.tabs.create({url:w}),void updateOptions({has_setup:!0})}getCurrentTab({},(e=>{h.recordingTabId=e.id;const{recordType:i}=h;"desktop"===i?chrome.windows.create({focused:!0,url:"/record.html",width:605,left:parseInt((window.screen.width-605)/2),type:"popup",height:500}).then((e=>{h.recordBgTabId=e.tabs[0].id,h.recordBgWinId=e.id})):"camera"===i&&chrome.tabs.create({url:"/record.html",pinned:!0}).then((e=>{h.recordBgTabId=e.id})),chrome.tabs.onUpdated.addListener((function(e,i){e===h.recordBgTabId&&"complete"===i.status&&(chrome.runtime.sendMessage({action:"startRecord",recordOptions:h}),saveStorage("recordingInfo",h),setTimeout((function(){window.close()}),100))}))}))}}Promise.all([getAllDevices(),getMicPermisstion(),getCamPermisstion()]).then((function(){isAllowedMic&&"true"==options.record_mic&&availableAudioDevices.length>0?($("#record-mic").prop("checked",!0),$("#record-mic").parents(".record-option-item").find(".source-part").show(),$("volume-canvas").show(),$("#mute").hide(),$("#audio").show(),$("#mic-device").attr("aria-label",chrome.i18n.getMessage("off_mic_btn"))):!isAllowedMic||availableAudioDevices.length<1?($("#mute").show(),$("#mute").find(".svg-icon").addClass("red"),$("#audio").hide(),$("#mic-device").attr("aria-label",chrome.i18n.getMessage("on_mic_btn"))):"true"!==options.record_mic&&($("#mute").show(),$("#mute").find(".svg-icon").removeClass("red"),$("#audio").hide(),$("#mic-device").attr("aria-label",chrome.i18n.getMessage("on_mic_btn"))),isAllowedCam&&"true"==options.record_cam&&availableVideoDevices.length>0?($("#record-cam").prop("checked",!0),$("#record-cam").parents(".record-option-item").find(".source-part").show(),$("#nocam").hide(),$("#cam").show(),$("#cam-device").attr("aria-label",chrome.i18n.getMessage("off_cam_btn"))):!isAllowedCam||availableVideoDevices.length<1?($("#nocam").show(),$("#nocam").find(".svg-icon").addClass("red"),$("#cam").hide(),$("#cam-device").attr("aria-label",chrome.i18n.getMessage("on_cam_btn"))):"true"!==options.record_cam&&($("#nocam").show(),$("#nocam").find(".svg-icon").removeClass("red"),$("#cam").hide(),$("#cam-device").attr("aria-label",chrome.i18n.getMessage("on_cam_btn"))),$(".option-source").find("select").on("change",(function(){var e=$(this).attr("data-source"),i=$(this).val();options[e+"-deviceId"]=i,$(".tab-record").hasClass("active")&&"mic"===e?(!1===options.record_mic&&updateOptions({record_mic:!0}),updateAudioDeviceUI(!0)):$(".tab-record").hasClass("active")&&"cam"===e&&(updateOptions({record_cam:!0}),updateCamDeviceUI(!0))})),$(".device-recording-select").find("select").on("change",(function(e){var i=$(this).attr("data-source"),o=$(this).val();updateOptions({[i+"-deviceId"]:o}),"mic"===i?Bg.changeAudioId(o):"cam"===i&&sendMessage({action:"change-camera"})})),$("input[name=record-type]").on("change",(function(e,i){isAutoRecordTab=!(!i&&!haveSetDefaultTab),haveSetDefaultTab||i?haveSetDefaultTab=!1:("custom"!==this.value&&updateOptions({record_type:this.value}),hiddeAutoTabRecordTip()),isAutoRecordTab||(updateAudioDeviceUI(!0===options.record_mic),updateCamDeviceUI(!0===options.record_cam)),updateRecordTypeUI(this.value),$("#record-menu").attr("class",this.value)})),$(".setup-btn").on("click",(function(){openNewTab("/getAccess.html")})),haveSetDefaultTab?autoSelectTabRecord():($("#record-type-"+options.record_type).trigger("click",["autofill"]),hiddeAutoTabRecordTip()),$("#more-action").on("click",(function(){$(".video-setting-wrapper").addClass("show"),$(".menu-content").addClass("show")})),$(".video-setting-wrapper").on("click",(function(){$(".menu-content").removeClass("show"),$(".video-setting-wrapper").removeClass("show"),updateTimerTips()})),$("#back-menu").on("click",(function(){$(".menu-content").removeClass("show"),$(".video-setting-wrapper").removeClass("show"),updateTimerTips()})),$(".menu-content").on("click",(function(e){e.stopPropagation()})),$("#auto-stop-action").on("click",(function(){$(".video-setting-wrapper").show(),$(".menu-content").addClass("show"),updateAutoTimerUI()})),haveAudioDevices?availableAudioDevices.length?(i("mic",availableAudioDevices),o("mic",availableAudioDevices)):($(".setup-mic-btn").show(),$(".record-option-microphone").find(".action").hide()):$(".record-option-microphone").find(".record-option-title").text("No Microphone detected").addClass("no").end().find(".action").hide(),haveVideoDevices?availableVideoDevices.length?(i("cam",availableVideoDevices),i("cam-only",availableVideoDevices),o("cam",availableVideoDevices),$("#cam-only-source-part").show()):($(".setup-cam-btn").show(),$(".record-option-camera").find(".action").hide()):($(".record-option-camera").find(".record-option-title").addClass("no").text("No Camera detected").end().find(".action").hide(),$(".record-option-camera-only").find(".record-option-title").addClass("no").text("No Camera detected"))})).catch((function(e){})),$("#mic-reminder").prop("checked",options["allow-remind-mic"]),updateTimerVisiable(),$(".custom-select[data-option=save-location]").find(".select-option-item[data-value="+options["save-location"]+"]").trigger("mousedown",["autofill"]),$(".custom-select[data-option=save-capture-location]").find(".select-option-item[data-value="+options["save-capture-location"]+"]").trigger("mousedown",["autofill"]),$(".custom-select[data-option=record_countdown]").find(".select-option-item[data-value="+options.record_countdown+"]").trigger("mousedown",["autofill"]),$("#countdown-input").on("change",(function(){options.record_countdown=$(this).val()})),$("#record-tabsound").prop("checked",options.record_tabsound),t(),$("#record-tabsound").on("change",(function(){options.record_tabsound=$(this).prop("checked"),t()})),$("#ctl-bar").on("change",(function(){updateOptions({ctrl_bar:$(this).prop("checked")}),updateCtlBarUI($(this).prop("checked"))})),$("#mic-reminder").on("change",(function(){updateOptions({"allow-remind-mic":$(this).prop("checked")})})),$("#auto-stop").on("change",(function(){updateTimerVisiable(),"recording"===recordingStatus&&Bg.updateAutoStop($(this).prop("checked")),updateRecordingUI()})),$("#local-recording").on("click",(function(){openNewTab("/video-list.html")})),$(".record-option-source").find(".field-head").on("click",(function(){"ctl-bar"===$(this).attr("data-type")&&(updateOptions({ctl_bar:!options.ctl_bar}),updateCtlBarUI(options.ctl_bar))})),$(".record-option-source").find(".device-item").on("click",(function(){var e=$(this).attr("data-type");if("mic"===e){var i=!1,o="none"===$("#audio").css("display");isAllowedMic?options.record_mic&&!o?updateOptions({record_mic:!1}):(updateOptions({record_mic:!0}),i=!0):openNewTab("/getAccess.html"),updateAudioDeviceUI(i)}else if("cam"===e){var a=!1;isAllowedCam?"camera"!==$("input[name=record-type]:checked").val()&&(options.record_cam?updateOptions({record_cam:!1}):(updateOptions({record_cam:!0}),a=!0),updateCamDeviceUI(a)):openNewTab("/getAccess.html")}else"tabsound"===e&&(updateOptions({record_tabsound:!options.record_tabsound}),t())})),$(".record-option-checkbox").on("change",(function(){var e=$(this).attr("data-type");if($(this).prop("checked")){if("mic"===e)var i=isAllowedMic;else if("cam"===e)i=isAllowedCam;options["record_"+e]="true",!0===i?($("#"+e+"-source-part").show(),"cam"===e&&!options.record_mic&&isAllowedMic&&availableAudioDevices&&(updateOptions({record_mic:!0}),$("#record-mic").prop("checked",!0),$("#mic-source-part").show()),"mic"===e&&getVolume()):openNewTab("/getAccess.html")}else updateOptions({["record_"+e]:!1}),$("#"+e+"-source-part").hide(),"mic"===e&&closeVolume()})),$(".popup").find(".close").on("click",(function(){$(this).parents(".popup").hide(),this.classList.contains("cancel")&&setSaveLocal()})),$(".popup").find(".sub-item").on("click",(function(){var e=$(this).attr("data-type");"image"===e?(updateOptions({"save-capture-location":"local"}),updateSavePlace()):"video"===e?(updateOptions({"save-location":"local"}),updateSavePlace()):"invite"===e&&openNewTab(baseURL+"/invite"),$(this).parents(".popup").hide()})),$("#cancel-off").on("click",(function(){$(this).parents(".popup").hide()})),$("#comfig-off").on("click",(function(){Bg.updateAutoStop(!1),updateRecordingUI(),$(this).parents(".popup").hide()})),$("#cancel-edit").on("click",(function(){$(this).parents(".popup").hide()})),$("#comfig-edit").on("click",(function(){var e=parseInt($("#e-sec-field")[0].value),i=parseInt($("#e-min-field")[0].value),o=parseInt($("#e-hour-field")[0].value);e+i+o>0&&(haveEditTimer&&Bg.updateAutoTimer(o,i,e),updateRecordingUI(),$(this).parents(".popup").hide())})),$("#edit-action").on("click",(()=>{updateAutoTimerFromBg(),openPopup("timer-edit")})),$("#cancel-action").on("click",(()=>{openPopup("timer-off")})),$(".input-field").on("focus",(function(e){$(this).attr("data-type");$(this).find("input")[0].focus()})),$(".input-field").find(".option-item").on("click",(function(){updateTimerValue($(this).attr("data-type"),$(this).attr("data-value"),!0)})),$(".input-field").find("input").on("focus",(function(e){var i=parseInt(e.target.value);isNaN(i)||0!=i||($(this)[0].value=""),$(this).parents(".input-field.time").addClass("focus")})),$(".input-field").find("input").on("blur",(function(e){$(this).parents(".input-field.time").removeClass("focus");var i=parseInt(e.target.value);isNaN(i)&&(e.target.value=0)})),$(".input-field").find("input").on("input",(function(e){updateTimerValue($(this).attr("data-type"),parseInt(e.target.value),!1)})),$(".input-field.reset").on("click",(function(){updateTimerValue("hour",0,!0),updateTimerValue("min",0,!0),updateTimerValue("sec",0,!0)})),$("#reset-Timer").on("click",(function(){Bg.resetTimer()})),$(".popup").find(".change-local").on("click",(function(){$(this).parents(".popup").hide(),setSaveLocal()})),$("#request-notification").on("click",(function(){chrome.permissions.request({permissions:["notifications"]},(function(e){$("#grant-notification").hide(),a()}))})),$("#mic-select-recording").on("click",(function(){availableAudioDevices.length<=0&&openNewTab("/getAccess.html")})),$("#cam-select-recording").on("click",(function(){availableVideoDevices.length<=0&&openNewTab("/getAccess.html")})),$("#back-to-main").on("click",(function(){switchView("main-menu")})),$("#record-stop").on("click",(function(){sendMessage({action:"stopStream"}),setTimeout((()=>{window.close()}),100)})),$("#record-pause").on("click",(function(){updatePausedUI(!0),Bg.pauseScreenRecording()})),$("#record-resume").on("click",(function(){updatePausedUI(!1),Bg.resumeScreenRecording()})),$("#record-discard").on("click",(function(){$("#discard-popup").show()})),$("#discard-cancel").on("click",(function(){$("#discard-popup").hide()})),$("#discard-confirm").on("click",(function(){Bg.stopStream(!0),window.close()})),$("#open-mic-cancel").on("click",(function(){a(!0)})),$("#open-mic-confirm").on("click",(function(){$(".device-item.mic").trigger("click"),a()})),$("#record-start").on("click",(function(){if("cloud"!==options["save-location"]||isSignIn){if("cloud"===options["save-location"]&&isSignIn&&parseInt(premiumLevel)<2&&videoTotalLimitation>=videoLimitation)return void openPopup("upgrade-alert-video");"alerted"!==options["alert-win"]&&navigator.platform.indexOf("Win")>=0&&"desktop"===$("input[name=record-type]:checked").val()?(openPopup("win-compter-audio"),updateOptions({"alert-win":"alerted"})):a(isAutoRecordTab)}else{if(!haveAudioDevices)return void openPopup("sign-in","record");if(0!==availableAudioDevices.length)return void openPopup("sign-in","record");var e="/setup-react.html?from=record";chrome.tabs.create({url:e})}})),$("#popup-audio-in-btn").on("click",(function(){$(this).parents(".popup").hide(),updateOptions({"alert-win":"alerted"}),a()})),$("#popup-sign-in-btn").on("click",(function(){var e=$(this).attr("data-reason");openNewTab("https://www.awesomescreenshot.com/signin?from="+("capture"===e?"ext_pop_capture":"record"===e?"ext_pop_record":"ext_pop_bottom"))})),$("#capture-guide").on("click",(function(){openNewTab("https://support.awesomescreenshot.com/hc/en-us/articles/4403241044249-How-to-take-a-screenshot-of-desktop-entire-screen-or-an-application-window")})),$(".upgrade-btn").on("click",(function(){var e=$(this).attr("data-reason");Bg.googleEvent("upgrade from recording menu ("+e+")","upgrade"),Bg.goToUpgrade(e)})),$("#toggle-camera").on("click",(function(){sendMessage({action:"init-camera"}),Bg.cameraStream||$("#toggle-camera").find(".camera-action-icon").addClass("loading")})),$("#toggle-mic").on("click",(function(){Bg.toggleMic()})),$("#toggle-ann-menu").on("click",(function(){Bg.toggleToolbar()}))}function updatePausedUI(e){var i=$("#recording_title");if(e)$("#recording-view").find(".recording-action").addClass("paused"),$("#recording-view").find(".time-field").addClass("paused"),i.html(chrome.i18n.getMessage("pause_title"));else{$("#recording-view").find(".recording-action");$("#recording-view").find(".recording-action").removeClass("paused"),$("#recording-view").find(".time-field").removeClass("paused"),i.html(chrome.i18n.getMessage("recording_title"))}}function updateRecordUI(){var e=$("#toggle-camera").find(".camera-action-icon"),i=$("#toggle-mic").find(".mic-action-icon"),o=$("#toggle-ann-menu").find(".toolbar-action-icon"),t=$("#toggle-camera"),a=$("#toggle-mic"),n=$("#toggle-ann-menu");Bg.cameraStream?(e.hasClass("nocam")&&e.removeClass("nocam"),t.attr("aria-label",chrome.i18n.getMessage("off_cam_btn"))):(e.hasClass("nocam")||e.addClass("nocam"),Bg.availableVideoDevices.length<1?e.hasClass("red")||e.addClass("red"):e.removeClass("red"),t.attr("aria-label",chrome.i18n.getMessage("on_cam_btn"))),$("#toggle-mic").find(".mic-action-icon").removeClass("loading"),$("#toggle-camera").find(".camera-action-icon").removeClass("loading"),Bg.audioStream?(i.hasClass("mute")&&i.removeClass("mute"),a.attr("aria-label",chrome.i18n.getMessage("off_mic_btn"))):(i.hasClass("mute")||i.addClass("mute"),Bg.availableAudioDevices.length<1?i.hasClass("red")||i.addClass("red"):i.removeClass("red"),a.attr("aria-label",chrome.i18n.getMessage("on_mic_btn"))),Bg.isShowToolbar?(o.removeClass("notoolbar"),n.attr("aria-label",chrome.i18n.getMessage("hide_ctl_bar"))):(o.addClass("notoolbar"),n.attr("aria-label",chrome.i18n.getMessage("show_ctl_bar")),$(".select-option-item.ann-tool-bar").addClass("disable"))}function setSaveLocal(){updateOptions({"save-capture-location":"local"}),updateSavePlace()}function createAudioMeter(e,i,o,t){var a=e.createScriptProcessor(512);return a.onaudioprocess=volumeAudioProcess,a.clipping=!1,a.lastClip=0,a.volume=0,a.clipLevel=i||.98,a.averaging=o||.95,a.clipLag=t||750,a.connect(e.destination),a.checkClipping=function(){return!!this.clipping&&(this.lastClip+this.clipLag<window.performance.now()&&(this.clipping=!1),this.clipping)},a.shutdown=function(){this.disconnect(),this.onaudioprocess=null},a}function volumeAudioProcess(e){for(var i,o=e.inputBuffer.getChannelData(0),t=o.length,a=0,n=0;n<t;n++)i=o[n],Math.abs(i)>=this.clipLevel&&(this.clipping=!0,this.lastClip=window.performance.now()),a+=i*i;var c=Math.sqrt(a/t);this.volume=Math.max(c,this.volume*this.averaging)}function closeVolume(){$("#volume-canvas").hide(),rafID&&window.cancelAnimationFrame(rafID),meter=null,volumeStream&&(volumeStream.getTracks().forEach((function(e){e.stop()})),volumeStream=null)}function getVolume(){if(options.record_mic&&isAllowedMic&&!1!==$("#main-menu").is(":visible")){closeVolume(),$("#volume-canvas").show();var e=new AudioContext,i={};options["mic-deviceId"]&&(i.deviceId=options["mic-deviceId"]);try{navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,navigator.getUserMedia({audio:i},(function(i){volumeStream=i,mediaStreamSource=e.createMediaStreamSource(i),meter=createAudioMeter(e),mediaStreamSource.connect(meter),drawLoop()}),(function(e){}))}catch(e){}}}function drawLoop(e){var i=document.getElementById("volume-canvas").getContext("2d");i.clearRect(0,0,5,18),meter&&(meter.checkClipping()?i.fillStyle="red":i.fillStyle="#47d892",i.fillRect(0,0,5,18*meter.volume*5)),rafID=window.requestAnimationFrame(drawLoop)}function updateTime(){$("#recording-view").find(".time").text(Bg.recordingTime),updateTimerProgress()}function restoreSettings(){var e=options.max_resolution,i=(options.record_toolbar,options.ctl_bar);"local"===options["save-location"]?isSignIn&&premiumLevel>1||(e=720):isSignIn?premiumLevel<=1&&videoTotalLimitation>=videoLimitation&&(e=720):e=720,$(".custom-select[data-option=max_resolution]").find(".select-option-item[data-value="+e+"]").trigger("mousedown"),updateCtlBarUI(i)}function updateCtlBarUI(e){e?($("#ctl-bar-icon").show(),$("#ctl-bar-off-icon").hide(),$(".ann-bar-field.ann-tool").removeClass("disable")):($("#ctl-bar-icon").hide(),$("#ctl-bar-off-icon").show(),$(".ann-bar-field.ann-tool").addClass("disable")),$("#ctl-bar").prop("checked",e)}function isNotAcceptedTab(e){return e.match(/chrome(.*):\/\//)||e.match(/edge(.*):\/\//)||e.match(/chrome-extension:\/\//)||e.match(/https:\/\/chrome.google.com\/webstore/i)||e.match(/https:\/\/ntp.msn.cn\/edge\/ntp/i)||e.match(/about:blank/)&&!1}initPopup();